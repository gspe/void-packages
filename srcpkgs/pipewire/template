# Template file for 'pipewire'
pkgname=pipewire
version=0.3.24
revision=1
build_style=meson
configure_args="-Dman=enabled -Dgstreamer=enabled -Ddocs=enabled -Dsystemd=disabled
 -Dbluez5=enabled -Dffmpeg=enabled -Dpipewire-alsa=enabled -Dpipewire-jack=enabled
 -Dvulkan=enabled -Dudevrulesdir=/usr/lib/udev/rules.d
 -Dvolume=enabled"
hostmakedepends="doxygen graphviz pkg-config xmltoman gettext"
# LDAC support can be enabled when ldacbt is packaged
makedepends="SDL2-devel ffmpeg-devel gst-plugins-base1-devel jack-devel
 sbc-devel v4l-utils-devel libva-devel libbluetooth-devel ncurses-devel
 libopenaptx-devel fdk-aac-devel"
depends="rtkit"
short_desc="Server and user space API to deal with multimedia pipelines"
maintainer="Kridsada Thanabulpong <sirn@ogsite.net>"
license="MIT"
homepage="https://pipewire.org/"
changelog="https://gitlab.freedesktop.org/pipewire/pipewire/-/raw/master/NEWS"
distfiles="https://gitlab.freedesktop.org/pipewire/pipewire/-/archive/${version}/pipewire-${version}.tar.gz"
checksum=aeca2b44660c4f36eed29cc9c6ccb093ea2778fd0e4ed7665cdfc40b2a49873f
conf_files="/etc/pipewire/pipewire.conf"

replaces="libpulseaudio-pipewire>=0"

if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
	makedepends+=" libatomic-devel"
	LDFLAGS+=" -latomic"
fi

post_install() {
	# vinstall ${FILESDIR}/pipewire.desktop 644 etc/xdg/autostart
	vlicense LICENSE
	vdoc "${FILESDIR}/README.voidlinux"
}

libjack-pipewire_package() {
	depends="libpipewire-${version}_${revision}"
	short_desc+=" - JACK client library"
	pkg_install() {
		vmove usr/lib/pipewire-0.3/jack
		vmove usr/bin/pw-jack
		vmove usr/lib/spa-0.2/jack
		vmove usr/share/man/man1/pw-jack.1
	}
}

alsa-pipewire_package() {
	depends="libpipewire-${version}_${revision}"
	short_desc+=" - ALSA client library"
	pkg_install() {
		mkdir -p ${PKGDESTDIR}/etc/alsa/conf.d
		vcopy "${DESTDIR}/usr/share/alsa/alsa.conf.d/*.conf" /etc/alsa/conf.d
		vmove usr/lib/alsa-lib
		vmove usr/share/alsa
		vmove usr/lib/spa-0.2/alsa
	}
}

pipewire-utils_package() {
	short_desc+=" - pipewire utilities"
	pkg_install() {
		vmove "usr/bin/pw-*"
		vmove "usr/bin/spa-*"
		vmove "usr/share/man/man1/pw-*"
	}
}

libpipewire_package() {
	short_desc+=" - pipewire library"
	pkg_install() {
		vmove "usr/lib/libpipewire-0.3.so.*"
		vmove "usr/lib/pipewire-0.3/*.so"
		vmove usr/lib/spa-0.2
		vmove usr/lib/udev/rules.d
		vmove usr/share/alsa-card-profile
	}
}

pipewire-devel_package() {
	depends="libpipewire-${version}_${revision}"
	short_desc+=" - pipewire and libspa development files"
	pkg_install() {
		vmove usr/include/pipewire-0.3
		vmove usr/include/spa-0.2
		vmove usr/lib/pkgconfig/libpipewire-0.3.pc
		vmove usr/lib/pkgconfig/libspa-0.2.pc
		vmove usr/lib/libpipewire-0.3.so
	}
}

gstreamer1-pipewire_package() {
	short_desc+=" - gstreamer plugin"
	pkg_install() {
		vmove usr/lib/gstreamer-1.0
	}
}

pipewire-doc_package() {
	short_desc+=" - documentation"
	pkg_install() {
		vmove usr/share/doc
	}
}

pipewire-jack-dropin_package() {
	depends="libjack-pipewire-${version}_${revision}"
	conflicts="jack"
	short_desc+=" - Use pipewire as drop-in replacement for JACK"
	pkg_install() {
		vinstall ${FILESDIR}/pipewire-jack.conf 644 etc/ld.so.conf.d
	}
}
